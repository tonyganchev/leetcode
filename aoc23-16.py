from enum import IntEnum
from numpy import Infinity
from test_utils import run_test
from typing import List, Tuple
from math import sqrt, ceil, floor
import re
import numpy as np
from functools import cache

up = '↑'
left = '←'
right = '→'
down = '↓'

dirs = {
    up: [-1, 0],
    left: [0, -1],
    right: [0, 1],
    down: [1, 0]
}

changes = {
    up: {
        '.': [up],
        '-': [left, right],
        '/': [right],
        '\\': [left],
        '|': [up],
    },
    left: {
        '.': [left],
        '-': [left],
        '/': [down],
        '\\': [up],
        '|': [up, down],
    },
    right: {
        '.': [right],
        '-': [right],
        '/': [up],
        '\\': [down],
        '|': [up, down],
    },
    down: {
        '.': [down],
        '-': [left, right],
        '/': [left],
        '\\': [right],
        '|': [down],
    }
}


def solve_internal(grid: List[str], entry_beam: Tuple[str, int, int]) -> int:
    width = len(grid[0])
    height = len(grid)
    mp = [[set() for _ in grid[0]] for _ in grid]
    beams = [entry_beam]
    while len(beams) > 0:
        new_beams = []
        for d, i, j in beams:
            di, dj = dirs[d]
            i, j = i + di, j + dj
            if i < 0 or i >= height or j < 0 or j >= width:
                continue
            if d in mp[i][j]:
                continue
            mp[i][j].add(d)
            new_beams.extend([(nd, i, j) for nd in changes[d][grid[i][j]]])
        beams = new_beams
    energized_count = 0
    # print()
    for i, r in enumerate(mp):
        for j, c in enumerate(r):
            if len(c) > 0:
                energized_count += 1
        #     if grid[i][j] != '.' and False:
        #         s = grid[i][j]
        #     else:
        #         if len(c) == 1:
        #             s = c.pop()
        #         elif len(c) == 0:
        #             s = '.'
        #         else:
        #             s = 'X'
        #     print(s, end='')
        # print()
    return energized_count


def solve(data: str) -> int:
    # print(data)
    grid = data.splitlines()
    return solve_internal(grid, (right, 0, -1))


def solve2(data: str) -> int:
    # print(data)
    grid = data.splitlines()
    up_beams = [(up, len(grid), j) for j in range(len(grid[0]))]
    left_beams = [(left, i, len(grid[0])) for i in range(len(grid))]
    right_beams = [(right, i, -1) for i in range(len(grid))]
    down_beams = [(down, -1, j) for j in range(len(grid[0]))]
    beams = up_beams + left_beams + right_beams + down_beams
    res = 0
    for beam in beams:
        r = solve_internal(grid, beam)
        print(beam, r)
        res = max(res, r)
    return res

small_vector = ''
official_vector = ''


def run_tests():
#     run_test(solve, [r'''..|..
# .....
# ..-..'''], 9)
#     run_test(solve, [r'''...\...
# .......
# -......
# .......
# \../...'''], 18)
    # run_test(solve_internal, [small_vector.splitlines(), (down, -1, 4)], 51)
    # run_test(solve_internal, [small_vector.splitlines(), (down, -1, 3)], 51)
    # run_test(solve, [small_vector], 46)
    # run_test(solve, [official_vector], 7185)
    run_test(solve2, [small_vector], 51)
    run_test(solve2, [official_vector], 7616)
    # run_test(solve2, [small_vector], 145)
    # run_test(solve2, [official_vector], 265345)
    # run_test(solve, [small_vector, 4], 87)
    # run_test(solve, [small_vector, 8], 87)
    # run_test(solve, [small_vector, 12], 87)
    # run_test(solve, [small_vector, 4000000], 64)
    # run_test(solve, [official_vector, 4000000], 36474)


small_vector = r'''.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....'''

official_vector = r'''\.......................|..-.............../../.......|...............\.\.....|..../.............|............
........................../....../..............................-............-.-..--.........-...........\/...
....\............../...........-...-......|.............................\...............-........-....|.......
......\....|................./.\................/..................../.......................|..\......-......
.................../..................-./.................../.....-...................|......\.......|\...\./.
.....|........../....................\../..\.../.\.......-.............\...........\......|.\..-..........-...
..../............/.....\...................../..--\........|......\....-...|.-...../......-........../........
..............\.-............./........./....|\.......\..........|.................|.|.................-......
.....|..........-................-.../..........-........................\.......|.........................-..
.|.-......./....................\........-.............../..\.|.-\...........\./.................-............
................|/............................../..-.\..................-..../../...../.../..../..........|...
........................./.....................\..\....-....../-.....................\|.........././.-........
...\.....................-...../|............--......-..|...../.....|......|.../.\....|.............\|.......\
.........-...-.....|.........../...-/........|......./|............-.......-.....\.............\|....../......
.....|...|.................|...../.............|.................../..........\|..\......|..|....-............
...........................-.........\......\.............\...................-.....-.\.......-.....|.........
.................-.............-......./.............-..\./......|....-..-..........-....-............\.......
.\..\.......-......|........................\.............-.......................|.........|\.|..\......--/..
..........-.....||--........|........-....../...........|../...-.........../.....-.\..........|.......-.......
..........\..........|..................\.................-..../............/..........|.......-........../...
..--......../..........-..|........./.........-...../........-.................|..\............../.....-......
.....\.............|...../......../............./||..........................\............|...................
..-.................-|..-....................\.................|...\.....\............./......-.......\.......
............-../......\...../.-....-.....-....-./../......\..|..|............................|.../..|.........
-................./................................................|...............|....|.....-.....|....../..
...........-...................|...........\.......-..\.......-...........|..-....../........|...............|
.........|...|-........../...-..........|.........\.....||......./....|...............\......-......\...../...
....|.........|............\.-.......................................-.......................|.-..|.\...\.-...
.|....|....-/....................\\..........................|........\|...|..............\..|......-.\../....
..|.\......|..../.....|.......-....................|.\..\............/......................|.....\../../.....
.......|\\.\/......................./.............|................../.........|.....\-.......................
......................................../.../................\-..............-................./......\.......
............../............/\......./........................./......|............\/..........................
......./................|......../.........-............\.../.|....../....|...../..../......../...............
...................|............-\........../...\.......\....\.....-.........-./....|.........................
.....-..-\.................|\...........................|..........\........-...|.............................
..............................-.............-.......\......................../.......\|.......|...-....-......
\...................\..../.................\................|......-...-............./.-......................
........................./.|./...|..\.-............|.-.....-..........\....-..../.....|.......|...............
.................../......../..................|.|...............|.......|\.....|......|...............\/..|..
.........|....-......../........-./..|.../..|./...................-........|..................................
..|../............-......-.........................-..|....-................-..\....../...........|...........
....................-...............|.../.....|..../......../...|.......\.....-.....\..............-..\.-.....
...........\.........../............................................\......-................-.......|.....-...
..-............./.......-\...........|-..-../............../................................../...............
.................\.......\............../.|.......-...\............................................\.-........
.\....|....\......|........./.....--......................................|................\..|-..............
......../...............-..........................|...........................-.............-\.-..|..........
.......|......|/...\........./......../.....\.........\.......................-...........\..\................
.-..-../.............|................./../.................\........-......|.\.....||...................\|...
/......../....\.....|-..........\..............-.....|............/\......\...//....................\...-/....
................-...........-.-\-..........\.-./......../-................./../.\........................./...
-.........-.....|.....-..|..|.........|...................-..........\/.-.....................................
......./...../......\............-.|...............|..../.........|....\.................../..............|...
...........|.......|....|...............\........................\/..\......................................\.
......\........-.........................\..........\.............\......................\/.....\..|..........
......\...........|.........../..-............./........................../...-......../...............\..|...
..|............\../........../............\...|.......................-...............\-../.|...|\.....\......
.|....\.|....-|.........\......./.................../.|........|....../.--.\.....\..............-\\.........-.
......................./.......\...........|.\............-.....\.............\.........--......../.\..-.|../.
......../.............../......\.\....|.............../...........................-........-......../.........
.......|\.............|.../|/........../....\.....-....|.............-......./........\..\........\..|......-.
.............../...........-.....\..\....-...../...|......\...........................\...|...........|/......
.............|....../.................../..|.....................|.......|....//..............\...............
......./....\............................-.........................-/......../|......-....|.............../...
...........................|...................\...............................-.................|...........\
.............................-......./..../...................\.../...........-.|......................||.....
\....\....\...-./......../.........\................./................\...................|...........-.......
................-.../............/\..................\.\..-....../................./..........|...............
......../...\.......................\.......\..\......|.....|../..........\..........-.............|..........
../.........................................-\..........-.........|-./.....-...|..|.......\........-...../../.
.....|..........-......../|-..............|.................-...........|...\.....................\...........
.......|..............\....\.....-............../..\\..\.......-........./.........-..|...|................../
..........-.......-.-................../.........\\...../.....|..........\......./.|.............-...........\
..................................-..................|...........\../\...../..../...\................/........
...-.........................................................\.|..............\..................\............
-.|..|...................../../.|.......\.....|.....\.\...\.........-.................................../.....
...\./....../........\.......-.................\.........|............-.........../...........\.|.........|.\.
..........-...\.............-.-............-.-................/.....................|........|............-...
|......./............/..|..............\...............|.......|\................/....|.........|.........\..\
.....\../\./.....................-.............\..................|.|.........................................
............/......../.../.......\............/.........................\........................\............
....../..|.............../....................-.......\................................................|.....\
................................../.......././.......\.....|.\......-.........-..||......../........-.//......
........................\.......|............-....-...../..............................-............-....|...-
.....-.......|......\..|.........-....|......\......../..../.......\..........|....\.............||..\........
..........|...........-|.......\.......-....../...../..........||.......................\............-..|.....
.................../../..............................|....|................/........|-....|................/..
.....................\................/............................/-........./...|.............\...|..|\.....
.....\..\..........\......../......|.........-....-..-..|...........\....|./....\.\..\............../.........
.......-...............-....../...........-.......................|../...............|...|.........../..../...
.............|.../..................\..\..........-........||................\/...........-|..................
.............-..............-\.../.................|......\...../..........\...-.....-....../................\
.....-....................................-.........\/............../.............................|...........
./.|../......\\..........................................|..............\|/..-\..........................\....
...........-.........\............./....-........-....-....-.........\..\....-\...-...............--.........-
..\.............................\............................./\..........-.............-...-./........../....
.................../........\....|..-....|||./..............-......-./....................../..|...|..........
......\.........../............|\...|.-................../....................|\..|..\.............-./......|.
...........-...................-.|........................\...............|/..-...\...|/\...........|.........
............|..../..................................\.......................\........................-........
.\..........................|......|......../.|....................../.......\......\.............../.........
..........-.../............/..........................|....-......................|.-................|.-......
......../............-...|.....|......../-.....-|...|./.......-..................-\...........................
...............\.\/.-....././................-.../..../.............../-|.....-.......|......./..--...........
..........-\\.|-................./../..|.-.....--................../.................../.|.......-............
..\.................-..............-...............\.....|......................./..\.....--........./..../..\
.......-....../..............|..................\....|..|..........-.....|.|.-.........................\......
..../..\...\....................................||.|......................................|.......\/.........-
................\-.-.....||....\.........................-...................................................|'''

run_tests()
