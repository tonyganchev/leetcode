#
# @lc app=leetcode id=16 lang=python3
#
# [16] 3Sum Closest
#

from typing import List

# @lc code=start
from bisect import bisect_left
from collections import defaultdict
from math import inf

class Solution:
    def threeSumClosest(self, nums: List[int], target: int) -> int:
        nums.sort()
        sum2_map = defaultdict(list)
        for i in range(len(nums) - 1):
            for j in range(i + 1, len(nums)):
                sum2_map[nums[i] + nums[j]].append(set((i, j)))

        best_so_far = inf

        for s2, ns in sum2_map.items():
            def can_use(ii):
                for s in ns:
                    if ii not in s:
                        return True
                return False
            dt = target - s2
            idx = bisect_left(nums, dt)
            lidx = -1
            for i in range(idx - 1, -1, -1):
                if can_use(i):
                    lidx = i
                    break
            ridx = -1
            for i in range(idx, len(nums)):
                if can_use(i):
                    ridx = i
                    break
            for i in (lidx, ridx):
                if i != -1:
                    s3 = s2 + nums[i]
                    if abs(target - s3) < abs(target - best_so_far):
                        best_so_far = s3

        return best_so_far
# @lc code=end

from test_utils import run_test

def test(nums, target):
    return Solution().threeSumClosest(nums, target)

method = test

run_test(method, [[-1, 2, 1, -4], 1], 2)
run_test(method, [[-289,430,566,437,-556,-40,839,838,16,689,345,-232,0,-234,-169,-543,363,551,126,-595,535,-607,-796,263,-923,-75,-472,-265,-82,377,479,761,265,525,-380,-553,685,43,-297,406,-971,-258,-233,563,607,10,270,-478,589,-834,-611,-115,373,70,226,-943,810,508,-593,-237,-587,220,-763,-200,123,-356,-393,33,-629,799,3,-360,938,-501,618,926,-944,173,-540,-620,48,950,-793,-588,-147,-166,-753,982,-409,135,431,606,-969,477,493,582,82,-615,336,-71,-109,973,199,-687,222,-203,-430,-879,-4,325,722,757,-403,-639,156,353,215,-781,-113,-192,899,972,-716,-193,641,152,-632,-561,-156,905,632,39,-39,-266,-624,-99,-838,-339,393,-685,-702,909,-816,376,942,-142,-240,-184,-562,-860,-866,-514,487,-230,-10,-663,557,737,-700,-315,-559,694,628,-173,-165,860,-828,-191,-74,969,781,754,-457,388,166,93,440,594,102,473,821,-399,40,45,713,-251,-464,-921,-443,-917,147,768,-759,-263,-541,-805,927,409,496,-688,-947,365,903,-566,-236,509,-592,678,-417,684,185,333,-477,-705,-652,-509,218,-842,-778,-585,465,-384,323,-228,-445,499,894,592,-602,-749,330,-875,-756,119,-136,-978,-302,-105,197,-902,-439,947,846,824,-701,534,294,523,-811,252,-712,-542,-444,-144,450,-249,-720,-206,-381,-68,-897,-343,-83,-524,383,-378,749,-881,-458,-30,87,681,-98,901,577,-664,-586,963,830,875,770,756,897,391,-832,-869,168,484,-81,-731,511,-617,453,355,-840,-449,502,-70,-810,672,-19,-269,971,-672,-929,194,-610,-359,-500,-112,-363,-855,-891,381,-52,-497,918,-164,-301,264,-584,307,983,160,-833,-849,-291,774], 165], 165)