#
# @lc app=leetcode id=3573 lang=python3
#
# [3573] Best Time to Buy and Sell Stock V
#

from typing import List

# @lc code=start

from functools import cache

def sign(v):
    if v == 0:
        return 0
    return v / abs(v)

class Solution:
    def reduce_trend(self, trend: List[int]) -> List[int]:
        if len(trend) <= 3:
            return trend
        if trend[-1] - trend[0] == 0:
            return [trend[0] for x in range(3)]
        return [trend[0], trend[1], trend[-2], trend[-1]]

    def reduce_redundant_quotes(self, prices: List[int]) -> List[int]:
        if len(prices) <= 1:
            return [x for x in prices]
        reduced_prices = []
        start = 0
        dir = sign(prices[1] - prices[0])
        for i, p in enumerate(prices[1 : ], 1):
            d = sign(prices[i] - prices[i - 1])
            if d != dir:
                reduced_prices.extend(self.reduce_trend(prices[start : i]))
                dir = d
                start = i
        reduced_prices.extend(self.reduce_trend(prices[start : ]))
        return reduced_prices

    def maximumProfit(self, prices: List[int], k: int) -> int:
        @cache
        def best_profit(n: int,
                        start_index) -> int:
            if len(prices) <= 1 or n == 0:
                return 0
            best = 0
            for i in range(start_index, len(prices) - 1):
                p = prices[i]
                old_profit = 0
                for j in range(i + 1, len(prices)):
                    q = prices[j]
                    profit = abs(q - p)
                    if old_profit > profit:
                        continue
                    old_profit = profit
                    further_profit = best_profit(n - 1, j + 1)
                    best = max(best, profit + further_profit)
            return best
        
        self._best_profit = best_profit
        old_prices = prices
        prices = self.reduce_redundant_quotes(prices)
        print(f'Eliminated {len(old_prices) - len(prices)} quotes')
        return self._best_profit(k, 0)

# @lc code=end

from test_utils import run_test

def test(prices, k):
    return Solution().maximumProfit(prices, k)
method = test

run_test(method, [[1,7,9,8,2], 2], 14)
run_test(method, [[12,16,19,19,8,1,19,13,9], 3], 36)
run_test(method, [[12,13,14,15,16,17,18,19,19,8,1,19,13,9], 3], 36)
run_test(method, [[19,1,9,14,11,11,5,19,11,15,3,20,4], 1], 19)
run_test(method, [
    [
        932399777,317611728,417122454,947719919,910754565,514859505,492296426,
        665668006,466895368,569729866,760232614,718368296,115210581,754589970,
        383542744,53652640,871383247,59521707,541281278,528698410,633832876,
        42581065,433844154,777265960,949924008,168857314,306135692,160860067,
        327968392,610797623,881729258,732795045,309404324,8922345,835949138,
        169476151,764631512,516574206,429618336,103794686,824921566,776693571,
        195302821,444248259,559029081,733538556,822150471,647143143,369464866,
        886872390,317292674,47404831,123062522,551297920,780518829,96585485,
        911180308,245987270,458547795,832067061,927621749,807576808,846051499,
        134535348,159729444,889187543,82602965,101214107,35295903,577204604,
        234615982,607222968,737943781,629244901,147733284,474789826,664082220,
        185076474,109064910,987160044,518734975,922751290,292370594,562107902,
        362287760,860942382,471178699,561298007,833371875,151501969,611344970
    ], 41], 20202103992)
run_test(method, [
    [
        439905949,666304906,328728050,996405752,379313886,528209791,88582883,
        939135548,751069794,109146128,883868801,685035870,872864534,515610456,
        671402135,299270187,782796059,14959721,863144680,901085624,622229387,
        536656476,257303050,868839354,117275933,918430202,935695732,478547107,
        484151756,631419928,39696098,650941214,51074234,941181946,265314584,
        557086091,786537782,50596574,28828693,157162091,9857934,451956750,
        695591748,879988702,249629554,539569656,282083076,39183395,66614080,
        479066152,652564309,907349719,210005879,768785742,537258749,237393978,
        346271286,392541722,312074103,126562356,400828204,614474102,364762040,
        8363356,539354781,90084496,319405489,644955686,889207045,798527610,
        141688158,529097227,598399178,87898767,830035760,49071715,600386530,
        40425784,322514114,778707680,79388396
    ], 30], 17891684807)
run_test(method, [
    [
        181336164,575650561,154358415,237356061,719665428,921156385,676345598,
        15381212,159900114,427268027,283868997,650714755,530188418,569453546,
        653877739,574148665,768706546,246808898,721031258,894358573,842702171,
        226669257,99990757,114326553,423842496,191126459,782880502,913598387,
        832587181,909274908,490222314,323602317,892924681,550584933,725995002,
        719922221,360412457,908802940,457514653,784557241,25039821,936801442,
        533485016,75662438,328191345,658625502,126022137,962208593,226172216,
        955062508,967459228,376627384,315021832,643166378,95199089,205570683,
        64048057,247788390,635312540,949015063,532348361,24941929,880280892,
        434816253,400504170,426990835,656471760,486647554,937373531,754573832,
        943686126,741047049,502160127,487645649,712616580,994765092,453421192,
        859637395,12599065,277470188
    ], 28], 16128470180)
run_test(method, [
    [
        903298463,576454110,909182057,252689344,449970570,22506777,721461800,
        278614029,141220941,65337631,737574790,255305128,55566908,287575767,
        776710615,826953347,407826891,877027185,951888018,533186400,609463572,
        192917423,498033756,742247132,453642493,155972525,262384578,756155044,
        927527938,905221696,426398584,320884572,591276208,144093834,446862221,
        394161917,946142122,719461400,687709424,506897011,176108835,35336349,
        873735237,618579347,653890942,29540118,112343007,605688820,890066193,
        301082114,85242779,183584962,213469933,827764103,682785036,311291646,
        220374859,426025894,113996056,396479072,725828677,424677358,572584550,
        152022093,755720933,696097968,722946,317632657,347193174,396417303,
        551012814,383730902,121404450,140006958,19194016,951524010,464966636,
        450719636,108005828,173335313,611132934,701342109,9045587,58518057,
        493866835,767114581
    ], 16], 12227566495)
run_test(method, [
    [
        940678518,350724614,92375020,562689787,720526224,906927531,751654158,
        296762479,30408296,727864976,360551176,356834109,585881587,230305403,
        533887941,906111651,852417213,290839238,589382490,373692989,512936731,
        485314266,209026218,719446292,330880310,810673055,39877957,900759793,
        384931389,403968210,93751665,863765253,505505391,149368397,305072670,
        42697783,307587326,525082865,531634069,17248095,368629133,894709495,
        61072062,882927898,780716288,180240305,579805019,156060999,384493639,
        581855580,694217178,699300409,869615685,640583974,431305019,597392621,
        855748129,712050194,882752401,618483706,617220483,614613005,913749736,
        447919,50964605,497167178,421954180,7481488,536559988,426703689,
        84086833,924859702,202312059,791451379,621023173,686218917,924046427,
        772314459,283888438,871494386,835689392,139364485,547131768,119230633,
        978800234,197970749,212614264,183320024,118776579,386733425,100362710,
        298088856,473125710,661066092,229932001,544343931,190424461,120774675,
        439798161
    ], 38], 19764485790)
run_test(method, [
    [
        179243046,457752262,286178474,74900793,664869156,623690025,263507509,
        60698978,606558337,466625805,518839826,45387178,952305782,443286689,
        819195430,381669990,748639178,491960526,593888665,108466784,209486091,
        192627773,392749576,481600364,873868658,982738462,355546694,713642444,
        126636038,301267454,386659462,898451741,411231814,305322835,948100352,
        840141463,204113409,289767793,396618833,908751332,527523511,709668164,
        803832476,277264298,909025594,108746829,624308199,641869384,522871761,
        590397605,544686108,263147267,871171190,283613188,941044756,693031565,
        539124630,277293228,520424862,268323821,630903423,173303119,945488410,
        807328996,989019329,12939977,881360412,986261890,554642105,387313733,
        349887442,574733921,61700079,831054349,534974480,81838745,818999074,
        81518219,443677735,644063587,550141377,563566315,842840069,669411786,
        16505012,571066756,870224492,480768473,591541175,24553713,475610665,
        751765103,461257247,952692083,533625473,844869172,130245064,618207854,
        181121953,688943310,134405780,101377293,299309831,241642523,556576692,
        964043746,535883684,347742442,467994424,521373280,869868011,106606480,
        929062292,987513138,883755175,689267479,982614107,250037478,948120083,
        190237646,281307112,835276571,685644108,249092019,865072338,205894633,
        304703585,286698703,753305030,632528824,875715184,681612331,207729125,
        404966183,919442257,392443643,735668637,923543255,371091318,865492349,
        500187674,653194567,603893586,239852060,808669596,406446521,537103884,
        498748666,398878812,828646366,798952127,436875402,787614389,658971817,
        885311390,437569942,178731690,620961434,789683410,807358873,538770410,
        309175493,367582115,145765868,782355992,899864451,70679216,197217500,
        275672471,721669352,59410827,222376190,137354667,138462286,135774325,
        493203379,251603085,329016514,368052707,866056849,4802212,44927261,
        242260121,623620103,591228582,157111840,654878099,63866065,785869792,
        461469998,580369892,299432963,451510808,370665972,214510999,702416483,
        341083349,222628830,998867355,754461264,537864437,332745281,697689945,
        830384422,874811469,145975985,110340254,756608623,362692009,332668354,
        201353383,5537790,956947736,398302269,783574734,443965077,931062634,
        78233581,728373431,912686191,591119699,502481140,789847354,841206468,
        226979982,321344831,568373927,271160091,265917605,384802979,565784262,
        430373673,322332488,691095172,390290669,556210048,340085536,117423726,
        888094786,224201458,718847920,672154371,278066789,98259584,340337370,
        573017573,911251190,444704820,191730165,91442404,860869480,994701002,
        844979582,713249666,277654376,548227430,538287701,284036438,318143895,
        896633282,228252092,294403681,821657256,886196408,405276852,182527654,
        163275461,952111470,664159845,310817726,490455597,124194805,581332222,
        701352496,240396691,799936171,772480922,141536733,606562852,398625860,
        56965886,35031100,892376582,486235264,994587495,212903985,84851311,
        251411523,743472595,249655034,649028773,973966874,558468362,522858911,
        172270746,289054591,821170203,868859825,648962431,318555831,549641233,
        626922783,47758170,418411773,831391686,842417150,890001809,597880198,
        68520402,607474836,870709570,568596234,828600855,974080684,683223730,
        14773928,712845158,985783521,989358853,933813818,232011226,942579142,
        970494230,616059605,795072322,422765295,517992965,745040387,928426038,
        367724731,947809001,571461518,520550567,210968753,618383348,171588523,
        773656261,446714913,975876613,846772524,610879388,21074875,575459633,
        896458814,796847773,563494660,404204125,901252519,188299634,273963534,
        436539630,290495565,393398578,266517751,724397241,427601881,519567761,
        972086164,717147728,213859411,532948513,774384044,404701680,285929898,
        545444367,135576573,391170479,723770630,40277336,706639384,241950026,
        274118643,274620872,834526131,807389292,864841670,772100735,145765140,
        105591575,232438788,772948834,437920157,993098077,892399248,171476965,
        402648449,601121051,192547033,847054600,925197102,97320910,36037760,
        129238583,521486624,65895820,72726487,377744131,322791405,35781811,
        920019801,990558804,91748249,720423033,600441549,444588996,109986791,
        721586274,430460073,227763703,372009821,705606250
    ], 17], 16115186969)