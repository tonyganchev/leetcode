import std;
import utils;

using namespace std;

enum dir { up = 0, right = 1, down = 2, left = 3 };

enum tile {
    obstacle = 1 << 4
};

const int dir_y[] = { -1, 0, 1, 0 };
const int dir_x[] = { 0, 1, 0, -1 };

void dump(const vector<int>& room, const int width, const int moves) {
    for (int i = 0; i < room.size() - width; i += width) {
        for (int j = 0; j < width; j++) {
            auto t = room[i + j];
            if (t == tile::obstacle) {
                cout << '#';
            } else if (t == 0) {
                cout << '.';
            } else if (t == 1 << dir::up) {
                cout << '^';
            } else if (t == 1 << dir::right) {
                cout << '>';
            } else if (t == 1 << dir::down) {
                cout << 'v';
            } else if (t == 1 << dir::left) {
                cout << '<';
            } else {
                cout << 'X';
            }
        }
        cout << endl;
    }
    cout << moves << endl;
}

static auto parse_room(
        const string_view situation,
        vector<int>& room,
        int& width,
        int& height,
        int& pi,
        int& pj) {
    auto lines = situation | views::split('\n');
    for (const auto [i, line_range] : views::zip(views::iota(0), lines)) {
        string_view line{ line_range };
        if (i == 0) {
            width = line.length();
            height = situation.length() / width;
        }
        for (const auto [j, t] : views::zip(views::iota(0), line)) {
            auto v = t == '#' ? tile::obstacle : 0;
            room[i * width + j] = v;
            if (t == '^') {
                pi = i;
                pj = j;
            }
        }
    }
}

static auto ttl(vector<int>& room, int width, int height, int pi, int pj) {
    int moves = 0;
    int direction = dir::up;
    while (true) {
        auto cy = pi + dir_y[direction];
        auto cx = pj + dir_x[direction];
        if (cy < 0 || cy >= height || cx < 0 || cx >= width) {
            return moves;
        }
        if (room[cy * width + cx] == tile::obstacle) {
            direction = (direction + 1) % 4;
        }
        else {
            pi = cy;
            pj = cx;
            moves += room[pi * width + pj] == 0 ? 1 : 0;
            if ((room[pi * width + pj] & (1 << direction)) != 0) {
                return -1;
            }
            room[pi * width + pj] |= (1 << direction);
        }
    }
    return 0;
}

static auto basic_problem(string_view situation) {
    vector<int> room(situation.size());
    auto width = 0;
    auto height = 0;
    auto pi = 0;
    auto pj = 0;
    parse_room(situation, room, width, height, pi, pj);

    return ttl(room, width, height, pi, pj);
}

static auto test_loop(
        vector<int> room,
        int width,
        int height,
        int pi,
        int pj,
        int oi,
        int oj) {
    room[oi * width + oj] = tile::obstacle;
    return ttl(room, width, height, pi, pj) == -1;
}

static auto advanced_problem(string_view situation) {
    vector<int> orig_room(situation.size());
    auto width = 0;
    auto height = 0;
    auto pi = 0;
    auto pj = 0;
    parse_room(situation, orig_room, width, height, pi, pj);

    vector<int> room{ orig_room };
    ttl(room, width, height, pi, pj);

    int variants = 0;

    for (int i = 0; i < height; i++) {
        for (int j = 0; j < width; j++) {
            if (i > 0) {
                if ((room[(i - 1) * width + j] & (1 << dir::down)) != 0) {
                    if (test_loop(orig_room, width, height, pi, pj, i - 1, j)) {
                        cout << (i - 1) << ":" << j << endl;
                        variants++;
                    }
                }
            }
            if (i < height - 1) {
                if ((room[(i + 1) * width + j] & (1 << dir::up)) != 0) {
                    if (test_loop(orig_room, width, height, pi, pj, i + 1, j)) {
                        cout << (i + 1) << ":" << j << endl;
                        variants++;
                    }
                }
            }
            if (j > 0) {
                if ((room[i * width + j - 1] & (1 << dir::right)) != 0) {
                    if (test_loop(orig_room, width, height, pi, pj, i, j - 1)) {
                        cout << i << ":" << (j - 1) << endl;
                        variants++;
                    }
                }
            }
            if (j < width - 1) {
                if ((room[i * width + j + 1] & (1 << dir::left)) != 0) {
                    if (test_loop(orig_room, width, height, pi, pj, i, j + 1)) {
                        cout << i << ":" << (j + 1) << endl;
                        variants++;
                    }
                }
            }
        }
    }

    return variants;
}

int main() {
    auto small_vector = R"(....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...)"sv;
    auto large_vector =
        "......................#...#..............#.....................................#...#..............##..............................\n"
        "......#.....#................#....#...........#........#......................#...............................#.....#.#.###..#...#\n"
        "...#.#.................#........#.................#.........................................................#.....................\n"
        ".....................................................................................................#.........#..................\n"
        ".............................#.................#...................................#.....#....#........................#....#.....\n"
        "..........................#.....................................................................#..#.............#................\n"
        ".................#...........................#..........................#..............................#.#..#...................#.\n"
        "..#....#....#......................................................................#....#.........................................\n"
        "..................................#............#...........#...........................................#.#....#.............#.#...\n"
        "...#...##....................................................................................#..........#..................#......\n"
        "..................#.....#......#.....#...#.........#..#.............................#....##.............#...............##.#..#...\n"
        "......#...............................................................................................................#..........#\n"
        "...........#................................#.......#.............#...............#...................................#...........\n"
        "............##...........................#........................................................................#...............\n"
        "...............................#........#...#.................................#..#.#.............#...........#....................\n"
        "........#..........#.#....................................................#........#....#..#.................................#....\n"
        ".........#..............#........................#................................................................................\n"
        "..................#..........................#.............#..................#.#...........#.....#...............................\n"
        "...#...........#.#..........#.....................................................................................................\n"
        "..............#.................#.....................................................................#...#......#.....#..........\n"
        "..#.....#................................................................................................#.#.....#..........#.....\n"
        "#.#..........#...#.............................#...............#..................................................#.#.............\n"
        "..........................#..#.............#................................................................................#.....\n"
        "...#..............................................................................................#..............#..#.......#.....\n"
        "........................................#......#........................................#...................##...........#........\n"
        ".............#..............#...........................##...#............#.....#..#..............................................\n"
        "..#....#..#...............#........#.................#............................................#........##...............#.....\n"
        "................................................#.......#...........##.............................#.##...........................\n"
        "............................#..............#..#...........#...#.....#.#...................#.....#.............................#...\n"
        "....................#....................................................................................#........................\n"
        ".......................................................................................#.......................##..#..............\n"
        "#.............................#.............................................................#............................#........\n"
        "..............................................................................#.............#...#.........##......................\n"
        "...............#..........................#.............#............#...........................................#................\n"
        "................#........................#................................#...#............#.............................#........\n"
        "..............................................................#.....#..........#.......#........#....#..................#.........\n"
        "........................................................#..............................................................#.......#..\n"
        "..#........#............#........#...#.....#.......#..............................................................................\n"
        "..#..............#.#.....................................#..................................................#....##...............\n"
        "............#........................#..........##.................................................................#........#.....\n"
        "............#............#.#...............................................#.......#..............................................\n"
        "..................#.........................................#............................#......#..................#...........#..\n"
        "........................................................#.............##................................#........................#\n"
        ".....................#...#......#.......#............#........#..................#...#.#....................................#.....\n"
        "...........................................................................................#..............................#....#..\n"
        "....#...................#.............#..........#..................................#.............................................\n"
        "......................................#...............................................#..#........................................\n"
        ".................#..#............................................#.............................................................#.#\n"
        "............##...................................................................................#.........................#......\n"
        ".........#.................................................#..#........................................#.....#..........#.....#...\n"
        ".........#........................................................................................#.#...............#............#\n"
        "..........#..#...........#...................#.....#.......#......#....#..#.......................#..........#..........#.........\n"
        "......#...................................................#....#..............#....#.........##...#...............................\n"
        ".........#........#........................#...........................................................#.......#................#.\n"
        ".....................#...............................................#.##.........................................................\n"
        "................................................................................#.............#..............#............#.......\n"
        "......#..........#............................................#...#....................#...............................#.........#\n"
        "......................................#....#.........#..............................................................#...#.........\n"
        ".......##...#.#..........................................................#............#...........#........#...................#..\n"
        ".....#............................................................................#............................#..................\n"
        "....#..................#....#......#......#......................#......................#.......................................#.\n"
        "..#..............#..#............#.................................#............#..................#................#.............\n"
        "........................................................#....#...................................##.......................#.......\n"
        "..........#..................................#....#........#.......#..........................#................#...............#..\n"
        ".....................................#.................#..................#...........#...........................................\n"
        ".........#..............#...................................................................................#...................#.\n"
        ".................##.................................#.......#.......................................................#.........#...\n"
        "...........#.................#..........................#...............................#..#...........................#..........\n"
        ".....................................#...........................#...................#..............................#..#..........\n"
        ".............................#.....#.................................................#.................##...............#.......#.\n"
        "............#.........................................................................................................#...........\n"
        "..........##.............#...................#.#...........................................#....................................##\n"
        "..........#..#...#...............#........#........................................................#.................#............\n"
        "....................#......................#....................................................#.#.....................#.........\n"
        ".......................................#............#........................##............#....#..#..............................\n"
        "..........#..........#.....................................#.................................#.......#............................\n"
        "....#.............#...............................................................................................................\n"
        "..#..............................................#....#......#........................................#.................#.........\n"
        "...#......#.....#..............................#....#....................#......#..................#...................#.......#..\n"
        "...............#..#...........................##..................................................................................\n"
        "........#..#.....#.........................#.......#.............#..........................................#................#....\n"
        "...#......#.............#...............#.............................................................................##..........\n"
        "#.................................#.......#.........#.#.#...................................#...#.#...........#..........#........\n"
        "#.........#....#...#.........#.#.............................................................#....................................\n"
        "........................#.#.......#.................................................#.............................................\n"
        "...#...##...#..#...........................#.....#..........................#...............................#.......#.............\n"
        "................#..............................#..........##...................................................................#..\n"
        ".......................................................................#...#..#...#.....#....#..................##..........#.....\n"
        "#.....................#.........#........#.....................................................................#.....#.......#....\n"
        "...........#......................#.......#.................................................#........................#............\n"
        ".......#.........................................#.....#...#...........#................#....#......#...........#......#..........\n"
        "....#.............#...............................#...#....#..#..#...........................................#.............#......\n"
        "...#.........#..........................................#.....#...........^.#...#....#...........................#................\n"
        ".....#..#...............#...........................#.#..........#........................................................#.......\n"
        ".............#.......#.............................................................................................#...#..........\n"
        "..#...................#...............................#......#............#...........#.......#...................................\n"
        "...........#.......................#..........#...#.......................#..............#.............##.............#..#........\n"
        "..#............#.............#.......................................................#.....##....................................#\n"
        ".#.........#.....................................................................#.........#......................................\n"
        ".............#....................................................................#.....#.............#...#...........#..........#\n"
        "..........................#.....#...#......................#.................................#.....#.................#.......#....\n"
        "..........#.#.....................................................................................................................\n"
        "............#.......#....................#.......#.............................................#..................................\n"
        ".......................................#..#........#...................................................#..........................\n"
        "...................#........#....#........#..................#..........................................................#.........\n"
        "........#..............#....................#............#......#...........#.....#..............................#.........#......\n"
        ".......#.....#.................#.#..#..............................................................#.......#..#...........#......#\n"
        ".#....................##.....................................................#...#.....#..........................................\n"
        "...........#..................#.....#....#............#...............#....#............#.......................#.................\n"
        "........#.....................................#......##............#..........................#..........#....................#...\n"
        "..........................#...............................................................#.......................................\n"
        "......................#..................................#.....................#.............................................#...#\n"
        ".........#..............................................................#........##.........#.......#.............................\n"
        "....#...#........#...........#....#.............#............#.....#..............................................................\n"
        "...........#...............................................................................................#.......#..#...........\n"
        "........#..........................#............................#...........#............#.............................#..........\n"
        ".......#...........................#...#...............#..#..#...................#.........#......................................\n"
        "..#..............................#........#...........#.......................................#...#...............................\n"
        ".............#...#.............#.........#...........#.....................................#................#.....................\n"
        ".........................#..........................#.................................#...........................................\n"
        "..................##.............#........#......#............#........................#.......#......................#....#......\n"
        ".....#............................................................................................................................\n"
        ".#..................................#.....#.............#...#.............................................#..............#..##..#.\n"
        "...............#........................................................#.........#..#..........#.........................#.......\n"
        ".............................................#...................#.................#..................#......................#....\n"
        "............................#.......................................................................................#.............\n"
        "............#...............#....................#....#..........#..#..............................#......#.......#.......##......\n"
        "............#.................................................................................#...................................\n"
        "........................#...............................................................#......#.......#.......#.......###......#.\n"
        "......................................#.#.........................................#.....#.............................#.........#."sv;
    cout << basic_problem(small_vector) << endl;
    cout << basic_problem(large_vector) << endl;
    cout << advanced_problem(small_vector) << endl;
    cout << advanced_problem(large_vector) << endl;
    return 0;
}
